<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Property Browser</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    details summary {
      cursor: pointer;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
    }
    .listing {
      cursor: pointer;
    }
    .sort-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Property Listings</h1>

    <details>
      <summary>Filter</summary>
      <form id="filter-form">
        <label>
          Property Type:
          <input type="text" name="Property type">
        </label>
        <label>
          Location:
          <input type="text" name="Location">
        </label>
        <div class="grid">
          <label>
            Min Price:
            <input type="number" name="minPrice">
          </label>
          <label>
            Max Price:
            <input type="number" name="maxPrice">
          </label>
        </div>
        <div class="grid">
          <label>
            Min Area (sqm):
            <input type="number" name="minArea">
          </label>
          <label>
            Max Area (sqm):
            <input type="number" name="maxArea">
          </label>
        </div>
        <div class="grid">
          <label>
            Min Bedrooms:
            <input type="number" name="minBedrooms">
          </label>
          <label>
            Max Bedrooms:
            <input type="number" name="maxBedrooms">
          </label>
        </div>
        <div class="grid">
          <label>
            Min Bathrooms:
            <input type="number" name="minBathrooms">
          </label>
          <label>
            Max Bathrooms:
            <input type="number" name="maxBathrooms">
          </label>
        </div>
        <label>
          ID (New Code):
          <input type="text" name="New Code">
        </label>
        <button type="submit">Apply Filter</button>
      </form>
    </details>

    <div class="sort-controls">
      <label>
        Sort by:
        <select id="sort-field">
          <option value="">(none)</option>
          <option value="Property name">Name</option>
          <option value="Property type">Type</option>
          <option value="Price">Price</option>
        </select>
      </label>
      <label>
        <input type="checkbox" id="sort-desc"> Descending
      </label>
    </div>

    <div id="listings"></div>
    <div class="pagination">
      <button id="prev-page">&laquo; Previous</button>
      <span id="page-info"></span>
      <button id="next-page">Next &raquo;</button>
    </div>

    <hr>
    <div id="row-content"></div>
  </main>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRW428ymgIgdzbRhVIs-oPZ2s8rhln-Q7X-k8v8pFzE3EqiSZ5xRPMdxiz5LJUC17Dp0pWHB8OGN77J/pub?gid=1412368678&single=true&output=csv";
    let listings = [];
    let headers = [];
    let currentPage = 1;
    const pageSize = 20;

    function normalizeHeaders(inputHeaders) {
      return inputHeaders.map(h => h.trim());
    }

    function applyFilter(formData) {
      listings = window.allRows.filter(row => {
        const map = {};
        headers.forEach((h, i) => map[h] = row[i] ? row[i].trim() : '');

        const price = parseInt(map["Price"].replace(/[^0-9]/g, "")) || 0;
        const area = parseFloat(map["Area Sqm."]) || 0;
        const bedrooms = parseInt(map["Bedroom"] || 0);
        const bathrooms = parseInt(map["Bathroom"] || 0);

        const minBedrooms = parseInt(formData["minBedrooms"] || 0);
        const maxBedrooms = parseInt(formData["maxBedrooms"] || 9999);
        const minBathrooms = parseInt(formData["minBathrooms"] || 0);
        const maxBathrooms = parseInt(formData["maxBathrooms"] || 9999);

        return (
          (!formData["Property type"] || map["Property type"].toLowerCase().includes(formData["Property type"].toLowerCase())) &&
          (!formData["Location"] || map["Location"].toLowerCase().includes(formData["Location"].toLowerCase())) &&
          (!formData["minPrice"] || price >= parseInt(formData["minPrice"])) &&
          (!formData["maxPrice"] || price <= parseInt(formData["maxPrice"])) &&
          bedrooms >= minBedrooms && bedrooms <= maxBedrooms &&
          bathrooms >= minBathrooms && bathrooms <= maxBathrooms &&
          (!formData["minArea"] || area >= parseFloat(formData["minArea"])) &&
          (!formData["maxArea"] || area <= parseFloat(formData["maxArea"])) &&
          (!formData["New Code"] || map["New Code"].toLowerCase().includes(formData["New Code"].toLowerCase()))
        );
      });
      currentPage = 1;
      renderListings();
    }

    function renderListings() {
      const sortField = document.getElementById("sort-field").value;
      const desc = document.getElementById("sort-desc").checked;
      if (sortField) {
        listings.sort((a, b) => {
          const aVal = (a[headers.indexOf(sortField)] || '').toLowerCase();
          const bVal = (b[headers.indexOf(sortField)] || '').toLowerCase();
          const aNum = parseFloat(aVal.replace(/[^0-9.]/g, "")) || 0;
          const bNum = parseFloat(bVal.replace(/[^0-9.]/g, "")) || 0;
          const isNumeric = !isNaN(aNum) && !isNaN(bNum);
          return isNumeric ? (desc ? bNum - aNum : aNum - bNum) : (desc ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal));
        });
      }

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const visible = listings.slice(start, end);

      const container = document.getElementById("listings");
      container.innerHTML = "";

      visible.forEach((row) => {
        const data = {};
        headers.forEach((header, i) => {
          data[header] = row[i] ? row[i].trim() : '';
        });

        const div = document.createElement("div");
        div.className = "listing";
        div.innerHTML = `
          <article>
            <strong>${data["Property name"] || "Unnamed Property"}</strong><br>
            Type: ${data["Property type"] || ""} | Location: ${data["Location"] || ""} | Price: ${data["Price"] || ""}
          </article>
        `;
        div.addEventListener("click", () => renderDetail(row));
        container.appendChild(div);
      });

      document.getElementById("page-info").textContent = `Page ${currentPage} of ${Math.ceil(listings.length / pageSize)}`;
    }

    function renderDetail(row) {
      const contentDiv = document.getElementById("row-content");
      const data = {};
      headers.forEach((header, i) => {
        data[header] = row[i] ? row[i].trim() : '';
      });

      contentDiv.innerHTML = `
        <article>
          <h2>${data["Property name"] || "Unnamed Property"}</h2>
          <h4>Type: ${data["Property type"] || "Unknown Type"}</h4>
          ${data["Pic"] ? `<p><a href="${data["Pic"]}" target="_blank" rel="noopener">View Pictures</a></p>` : ''}
          <p>Location: ${data["Location"] || ""}</p>
          <p>Unit: ${data["Unit No."] || ""}, Floor: ${data["Floor"] || ""}</p>
          <p>Bedrooms: ${data["Bedroom"] || ""}, Bathrooms: ${data["Bathroom"] || ""}</p>
          <p>Area: ${data["Area Sqm."] || ""} m&sup2;</p>
          <h3>Price: ${data["Price"] || "Contact us"}</h3>
          ${data["Remarks /ทิศ & วิว"] ? `<p>Remarks: ${data["Remarks /ทิศ & วิว"]}</p>` : ''}
          ${data["Sale/rent conditions  eg. Transfer free etc."] ? `<p>Conditions: ${data["Sale/rent conditions  eg. Transfer free etc."]}</p>` : ''}
        </article>
      `;
    }

    fetch(sheetUrl)
      .then(res => res.blob())
      .then(blob => blob.text())
      .then(csv => {
        const parsed = Papa.parse(csv.trim(), { skipEmptyLines: true });
        headers = normalizeHeaders(parsed.data[0]);
        window.allRows = parsed.data.slice(1);
        listings = window.allRows;
        renderListings();
      });

    document.getElementById("prev-page").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderListings();
      }
    });

    document.getElementById("next-page").addEventListener("click", () => {
      if (currentPage * pageSize < listings.length) {
        currentPage++;
        renderListings();
      }
    });

    document.getElementById("filter-form").addEventListener("submit", e => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(e.target).entries());
      applyFilter(formData);
    });

    document.getElementById("sort-field").addEventListener("change", renderListings);
    document.getElementById("sort-desc").addEventListener("change", renderListings);
  </script>
</body>
</html>
